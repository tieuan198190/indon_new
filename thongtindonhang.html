
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra C·ª©u Th√¥ng Tin ƒê∆°n</title>
    <style>
      :root {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto,
          sans-serif;
        color: #0f172a;
        background-color: #f4f6fb;
        line-height: 1.4;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: clamp(1rem, 2vw, 2rem);
        background: radial-gradient(
            circle at top,
            rgba(99, 102, 241, 0.08),
            transparent 45%
          ),
          #f4f6fb;
      }

      main {
        width: min(1100px, 100%);
        background: #fff;
        border-radius: 28px;
        padding: clamp(1.5rem, 4vw, 3rem);
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.12);
      }

      header {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 2rem;
      }

      header h1 {
        margin: 0;
        font-size: clamp(1.8rem, 3vw, 2.4rem);
      }

      header p {
        margin: 0.4rem 0 0;
        color: #475569;
      }

      .tagline {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.4em;
        color: #4f46e5;
        font-weight: 600;
      }

      form {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: flex-end;
      }

      .form-actions {
        display: flex;
        gap: 0.75rem;
        flex: 1 1 240px;
        align-items: stretch;
      }

      label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.35rem;
        color: #475569;
      }

      input,
      select,
      button {
        width: 100%;
        border-radius: 16px;
        border: 1.5px solid #e2e8f0;
        padding: 0.85rem 1.1rem;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input:focus,
      select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
        outline: none;
      }

      button {
        border: none;
        background: #111827;
        color: white;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 20px rgba(17, 24, 39, 0.2);
      }

      .ghost-button {
        background: #f8fafc;
        color: #0f172a;
        border: 1.5px dashed #cbd5e1;
      }

      .ghost-button:not(:disabled):hover {
        box-shadow: 0 12px 20px rgba(15, 23, 42, 0.12);
        border-color: #6366f1;
        color: #111827;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .summary-card {
        border-radius: 20px;
        padding: 1.25rem;
        background: #0f172a;
        color: white;
      }

      .summary-card small {
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 0.26em;
        font-weight: 600;
      }

      .summary-card strong {
        display: block;
        font-size: 1.9rem;
        margin-top: 0.5rem;
      }

      .summary-card span {
        display: block;
        font-size: 0.95rem;
        margin-top: 0.25rem;
        color: rgba(255, 255, 255, 0.85);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 24px;
        overflow: hidden;
      }

      thead {
        background: #111827;
        color: white;
      }

      th,
      td {
        padding: 1rem;
        text-align: left;
      }

      th {
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border-bottom: none;
      }

      tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.15s ease;
      }

      tbody tr:last-child {
        border-bottom: none;
      }

      tbody tr:hover {
        background: #f8fafc;
      }

      .location-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.4rem 1rem;
        border-radius: 999px;
        font-size: 0.9rem;
        background: #ecfdf5;
        color: #047857;
        font-weight: 600;
      }

      .note {
        font-size: 0.88rem;
        color: #475569;
      }

      .order-notes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .order-notes[hidden] {
        display: none !important;
      }

      .note-card {
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        padding: 1.25rem;
        background: #f8fafc;
      }

      .note-card strong {
        display: block;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #475569;
        margin-bottom: 0.5rem;
      }

      .note-card p {
        margin: 0;
        font-size: 0.95rem;
        color: #0f172a;
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #94a3b8;
      }

      .empty-state strong {
        display: block;
        color: #475569;
        font-size: 1.1rem;
        margin-bottom: 0.35rem;
      }

      .product-info {
        display: flex;
        align-items: center;
        gap: 0.9rem;
      }

      .product-thumb {
        width: 300px;
        height: 400px;
        object-fit: cover;
        border-radius: 16px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        box-shadow: 0 6px 15px rgba(15, 23, 42, 0.08);
      }

      .back-home-link {
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 1000;
        padding: 0.45rem 1rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 999px;
        font-weight: 600;
        color: #4338ca;
        text-decoration: none;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
        border: 1px solid rgba(99, 102, 241, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .back-home-link:hover,
      .back-home-link:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 18px 40px rgba(79, 70, 229, 0.25);
      }

      .back-home-link:focus-visible {
        outline: 3px solid rgba(79, 70, 229, 0.45);
        outline-offset: 3px;
      }

      .camera-panel {
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        padding: 1rem;
        background: #f8fafc;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
        margin-bottom: 1.5rem;
      }

      .camera-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .camera-video {
        width: 100%;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        background: #0f172a;
        aspect-ratio: 3 / 4;
        object-fit: cover;
      }

      .camera-status {
        margin-top: 0.65rem;
        font-size: 0.95rem;
        color: #475569;
      }

      .camera-status[data-tone="success"] {
        color: #0f766e;
      }

      .camera-status[data-tone="error"] {
        color: #b91c1c;
      }

      .close-camera {
        width: auto;
        padding: 0.6rem 0.9rem;
        border-radius: 12px;
        background: #111827;
        color: #fff;
      }
      .close-camera:not(:disabled):hover {
        box-shadow: 0 8px 12px rgba(17, 24, 39, 0.15);
      }
    </style>
  </head>
  <body>
    <a class="back-home-link" href="index.html" aria-label="Quay l·∫°i trang ch√≠nh C√¥ M·∫≠p Fashion">‚Üê Trang ch√≠nh</a>
    <main>
      <header>
        <div>
          <div class="tagline">C√¥ M·∫≠p Fashion</div>
          <h1>Tra c·ª©u th√¥ng tin ƒë∆°n</h1>
        </div>
      </header>

      <form id="lookup-form">
        <label style="flex: 1 1 260px">
          <span>M√£ ƒë∆°n</span>
          <input
            id="order-code"
            type="text"
            placeholder="V√≠ d·ª•: DH123456"
            autocomplete="off"
            required
          />
        </label>

        <div class="form-actions">
          <button id="submit-btn" type="submit">
            <span aria-hidden="true">üîç</span> Tra c·ª©u ƒë∆°n
          </button>
          <button id="open-camera-btn" type="button" class="ghost-button">
            <span aria-hidden="true">üì∑</span> Qu√©t b·∫±ng camera
          </button>
        </div>
      </form>

      <section id="camera-panel" class="camera-panel" hidden>
        <div class="camera-header">
          <div>
            <strong>Qu√©t m√£ b·∫±ng camera</strong>
            <div class="note" id="camera-hint">
              ƒê∆∞a m√£ QR ho·∫∑c barcode v√†o trong khung h√¨nh.
            </div>
          </div>
          <button id="close-camera-btn" type="button" class="close-camera">
            ƒê√≥ng
          </button>
        </div>
        <video id="camera-video" class="camera-video" autoplay playsinline muted></video>
        <div id="camera-status" class="camera-status" aria-live="polite">
          ƒêang kh·ªüi ƒë·ªông camera...
        </div>
      </section>

      <section id="order-notes" class="order-notes" hidden>
        <article class="note-card">
          <strong>M√¥ t·∫£</strong>
          <p id="description-text"></p>
        </article>
        <article class="note-card">
          <strong>Ghi ch√∫ n·ªôi b·ªô</strong>
          <p id="private-description-text"></p>
        </article>
      </section>

      <div class="table-wrapper" id="table-wrapper" hidden>
        <table>
          <thead>
            <tr>
              <th>S·∫£n ph·∫©m</th>
              <th>V·ªã tr√≠</th>
            </tr>
          </thead>
          <tbody id="result-body">
            <tr>
              <td colspan="2">
                <div class="empty-state">
                  <strong>Ch∆∞a c√≥ d·ªØ li·ªáu</strong>
                  K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y sau khi tra c·ª©u th√†nh c√¥ng.
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      const WEBHOOK_URL =
        "https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/thongtin_don";

      const form = document.getElementById("lookup-form");
      const orderInput = document.getElementById("order-code");
      const submitBtn = document.getElementById("submit-btn");
      const submitBtnDefault = submitBtn.innerHTML;
      const openCameraBtn = document.getElementById("open-camera-btn");
      const closeCameraBtn = document.getElementById("close-camera-btn");
      const cameraPanel = document.getElementById("camera-panel");
      const cameraVideo = document.getElementById("camera-video");
      const cameraStatus = document.getElementById("camera-status");

      const statusBar = document.getElementById("status-bar");
      const resultBody = document.getElementById("result-body");
      const tableWrapper = document.getElementById("table-wrapper");
      const notesSection = document.getElementById("order-notes");
      const descriptionText = document.getElementById("description-text");
      const privateDescriptionText = document.getElementById(
        "private-description-text"
      );

      const focusOrderInput = () =>
        requestAnimationFrame(() => {
          if (cameraPanel && cameraPanel.hidden === false) return;
          if (!orderInput.disabled) orderInput.focus({ preventScroll: true });
        });

      ["pointerdown", "touchstart", "touchend", "click"].forEach((evt) => {
        window.addEventListener(evt, () => focusOrderInput(), { passive: true });
      });
      window.addEventListener("focus", () => focusOrderInput());
      orderInput.addEventListener("blur", () => setTimeout(() => focusOrderInput(), 20));

      form.addEventListener("submit", handleLookup);
      let hasLookup = false;
      hideNotes();
      focusOrderInput();

      const cameraSupported =
        Boolean(navigator.mediaDevices?.getUserMedia) &&
        (typeof BarcodeDetector !== "undefined");
      let cameraStream = null;
      let cameraDetector = null;
      let cameraLoopId = null;
      let cameraStarting = false;

      if (!cameraSupported && openCameraBtn) {
        openCameraBtn.disabled = true;
        openCameraBtn.title =
          "Tr√¨nh duy·ªát hi·ªán kh√¥ng h·ªó tr·ª£ qu√©t m√£ b·∫±ng camera.";
      } else if (openCameraBtn) {
        openCameraBtn.addEventListener("click", () => startCameraScan());
      }

      if (closeCameraBtn) {
        closeCameraBtn.addEventListener("click", () => stopCameraScan());
      }

      document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopCameraScan(true);
      });

      // T·ª± ƒë·ªông b·∫≠t camera sau khi trang s·∫µn s√†ng
      if (cameraSupported) {
        window.addEventListener("load", () => startCameraScan());
      }

      /**
       * B·∫≠t camera v√† qu√©t m√£ barcode/QR, t·ª± ƒë·ªông ƒëi·ªÅn v√†o input.
       */
      async function startCameraScan() {
        if (cameraStarting || cameraStream) return;
        if (!cameraPanel || !cameraVideo || !cameraStatus || !cameraSupported) {
          alert(
            "Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ m·ªü camera. Vui l√≤ng nh·∫≠p m√£ th·ªß c√¥ng."
          );
          return;
        }

        cameraStarting = true;
        cameraPanel.hidden = false;
        updateCameraStatus("ƒêang kh·ªüi ƒë·ªông camera...", "info");
        if (openCameraBtn) openCameraBtn.disabled = true;

        try {
          cameraDetector = await initBarcodeDetector();
        } catch (err) {
          updateCameraStatus(
            err?.message || "Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ Barcode Detector.",
            "error"
          );
          if (openCameraBtn) openCameraBtn.disabled = false;
          cameraStarting = false;
          return;
        }

        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } },
          });
          cameraVideo.srcObject = cameraStream;
          await cameraVideo.play();
          updateCameraStatus("ƒêang t√¨m m√£... h√£y gi·ªØ m√£ trong khung h√¨nh.", "info");
          cameraLoopId = requestAnimationFrame(scanFrame);
        } catch (err) {
          console.error("Camera error", err);
          updateCameraStatus(
            "Kh√¥ng m·ªü ƒë∆∞·ª£c camera. Ki·ªÉm tra quy·ªÅn truy c·∫≠p ho·∫∑c th·ª≠ tr√¨nh duy·ªát kh√°c.",
            "error"
          );
          stopCameraScan(true);
          if (openCameraBtn) openCameraBtn.disabled = false;
        } finally {
          cameraStarting = false;
        }
      }

      async function initBarcodeDetector() {
        if (typeof BarcodeDetector === "undefined") {
          throw new Error("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ Barcode Detector.");
        }
        const preferred = [
          "qr_code",
          "code_128",
          "code_39",
          "code_93",
          "ean_13",
          "ean_8",
          "itf",
          "data_matrix",
        ];

        if (typeof BarcodeDetector.getSupportedFormats === "function") {
          const supported = await BarcodeDetector.getSupportedFormats();
          const usable = preferred.filter((fmt) => supported.includes(fmt));
          return new BarcodeDetector({ formats: usable.length ? usable : supported });
        }

        return new BarcodeDetector({ formats: preferred });
      }

      async function scanFrame() {
        if (!cameraDetector || !cameraVideo || cameraPanel.hidden) return;
        try {
          const barcodes = await cameraDetector.detect(cameraVideo);
          if (barcodes?.length) {
            const value = (barcodes[0].rawValue || "").trim();
            if (value) {
              updateCameraStatus(`ƒê√£ qu√©t: ${value}`, "success");
              orderInput.value = value;
              stopCameraScan();
              form.requestSubmit();
              return;
            }
          }
        } catch (err) {
          console.error("Barcode detect error", err);
          updateCameraStatus(
            "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c m√£. Th·ª≠ gi·ªØ camera ·ªïn ƒë·ªãnh v√† ƒë·ªß s√°ng.",
            "error"
          );
        }
        cameraLoopId = requestAnimationFrame(scanFrame);
      }

      function stopCameraScan(keepPanelOpen = false) {
        if (cameraLoopId) {
          cancelAnimationFrame(cameraLoopId);
          cameraLoopId = null;
        }
        if (cameraStream) {
          cameraStream.getTracks().forEach((t) => t.stop());
          cameraStream = null;
        }
        if (cameraVideo) {
          cameraVideo.srcObject = null;
        }
        if (!keepPanelOpen && cameraPanel) {
          cameraPanel.hidden = true;
        }
        if (openCameraBtn) openCameraBtn.disabled = false;
        if (!keepPanelOpen) focusOrderInput();
      }

      function updateCameraStatus(message, tone = "info") {
        if (!cameraStatus) return;
        cameraStatus.textContent = message;
        cameraStatus.dataset.tone = tone;
      }

      /**
       * G·ª≠i request l√™n webhook v√† hi·ªÉn th·ªã k·∫øt qu·∫£.
       */
      async function handleLookup(event) {
        event.preventDefault();
        const orderCode = orderInput.value.trim();

        if (!orderCode) {
          updateStatus("Vui l√≤ng nh·∫≠p m√£ ƒë∆°n h·ª£p l·ªá.", "empty");
          focusOrderInput();
          return;
        }

        orderInput.value = "";
        focusOrderInput();

        hasLookup = true;
        hideNotes();

        toggleLoading(true);
        updateStatus("ƒêang l·∫•y d·ªØ li·ªáu t·ª´ kho...", "loading");

        try {
          const payload = {
            order_code: orderCode,
          };

          const response = await fetch(WEBHOOK_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`Webhook tr·∫£ v·ªÅ l·ªói ${response.status}`);
          }

          const data = await response.json();
          const normalized = normalizePayload(data, orderCode);
          renderNotes(normalized);

          if (!normalized.items.length) {
            renderEmpty();
            updateStatus(
              "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o trong ƒë∆°n n√†y.",
              "empty"
            );
            return;
          }

          renderRows(normalized.items);
          updateStatus(
            `ƒê√£ t·∫£i th√¥ng tin ƒë∆°n ${normalized.orderCode} (${normalized.items.length} s·∫£n ph·∫©m).`,
            "success"
          );
        } catch (error) {
          console.error("Fetch error", error);
          renderEmpty();
          hideNotes();
          updateStatus(
            "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu. Ki·ªÉm tra webhook ho·∫∑c th·ª≠ l·∫°i sau.",
            "error"
          );
        } finally {
          toggleLoading(false);
        }
      }

      /**
       * Chu·∫©n ho√° d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ Webhook cho UI.
       */
      function normalizePayload(payload, fallbackCode) {
        if (!payload) {
          return {
            orderCode: fallbackCode,
            customer: "",
            updatedAt: new Date(),
            items: [],
            raw: payload,
          };
        }

        const rootPayload = Array.isArray(payload)
          ? payload[0] || {}
          : payload;
        const sourceArray = extractItems(payload);
        const items = sourceArray.map(mapItem);

        return {
          orderCode:
            rootPayload.order_code ||
            rootPayload.orderCode ||
            rootPayload.ma_don ||
            rootPayload.code ||
            items[0]?.orderCode ||
            fallbackCode,
          customer:
            rootPayload.customer_name ||
            rootPayload.customer ||
            rootPayload.customerName ||
            items[0]?.customer ||
            "",
          updatedAt: parseDate(
            rootPayload.updated_at ||
              rootPayload.updatedAt ||
              rootPayload.timestamp ||
              rootPayload.time ||
              Date.now()
          ),
          handler:
            rootPayload.staff ||
            rootPayload.process_by ||
            rootPayload.user ||
            rootPayload.handledBy ||
            "‚Äî",
          description:
            rootPayload.description ||
            rootPayload.desc ||
            rootPayload.notes ||
            rootPayload.note ||
            "",
          privateDescription:
            rootPayload.privateDescription ||
            rootPayload.private_description ||
            rootPayload.privateNote ||
            rootPayload.private_note ||
            "",
          items,
          raw: payload,
        };
      }

      /**
       * ƒê·ªìng b·ªô nhi·ªÅu ki·ªÉu field kh√°c nhau v·ªÅ chung m·ªôt c·∫•u tr√∫c.
       */
      function mapItem(item = {}) {
        const qty =
          Number(
            item.quantity ??
              item.qty ??
              item.qty_ordered ??
              item.so_luong ??
              0
          ) || 0;

        return {
          orderCode:
            item.order_code || item.orderCode || item.ma_don || undefined,
          customer:
            item.customer ||
            item.customer_name ||
            item.ten_khach ||
            undefined,
          sku:
            item.sku ||
            item.SKU ||
            item.product_code ||
            item.Product_code ||
            item.productCode ||
            item.ma_hang ||
            "‚Äî",
          name:
            item.product_name ||
            item.Product_name ||
            item.name ||
            item.ten_san_pham ||
            item.Product_code ||
            item.productCode ||
            item.sku ||
            "Kh√¥ng t√™n",
          variant:
            item.variant ||
            item.model ||
            item.size ||
            item.color ||
            item.thuoc_tinh ||
            "‚Äî",
          qty: qty || 1,
          location:
            item.location ||
            item.bin ||
            item.vi_tri ||
            item.khu ||
            "Ch∆∞a g√°n",
          note: item.note || item.ghi_chu || "",
          image:
            item.image ||
            item.image_url ||
            item.imageUrl ||
            item.thumbnail ||
            item.anh ||
            item.productImage ||
            "",
        };
      }

      function extractItems(payload) {
        let candidates = [];

        if (Array.isArray(payload?.items)) {
          candidates = payload.items;
        } else if (Array.isArray(payload?.data?.items)) {
          candidates = payload.data.items;
        } else if (Array.isArray(payload?.data)) {
          candidates = payload.data;
        } else if (Array.isArray(payload?.result)) {
          candidates = payload.result;
        } else if (Array.isArray(payload)) {
          candidates = payload;
        } else if (payload && typeof payload === "object") {
          candidates = [payload];
        }

        return flattenItems(candidates);
      }

      function flattenItems(list = []) {
        const result = [];

        list.forEach((entry) => {
          if (!entry) return;
          if (entry.json && typeof entry.json === "object") {
            result.push(...flattenItems([entry.json]));
            return;
          }
          if (Array.isArray(entry)) {
            result.push(...flattenItems(entry));
            return;
          }
          if (Array.isArray(entry.data)) {
            result.push(...flattenItems(entry.data));
            return;
          }
          if (Array.isArray(entry.items)) {
            result.push(...flattenItems(entry.items));
            return;
          }
          if (Array.isArray(entry.products)) {
            const { products, ...rest } = entry;
            products.forEach((product) => {
              if (!product) return;
              if (Array.isArray(product)) {
                result.push(...flattenItems(product));
                return;
              }
              result.push({ ...rest, ...product });
            });
            return;
          }
          result.push(entry);
        });

        return result;
      }

      function parseDate(value) {
        const date = value ? new Date(value) : new Date();
        if (Number.isNaN(date.getTime())) return new Date();
        return date;
      }

      function renderRows(items) {
        showResults();
        resultBody.innerHTML = "";

        items.forEach((item) => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>
              <div class="product-info">
                ${
                  item.image
                    ? `<img src="${item.image}" alt="${item.sku}" class="product-thumb" loading="lazy" onerror="this.remove()" />`
                    : ""
                }
                <div>
                  <strong>${item.name}</strong>
                </div>
              </div>
            </td>
            <td>
              <span class="location-pill">${item.location}</span>
            </td>
          `;

          resultBody.appendChild(row);
        });
      }

      function renderEmpty() {
        showResults();
        resultBody.innerHTML = `
          <tr>
            <td colspan="2">
              <div class="empty-state">
                <strong>Kh√¥ng c√≥ d·ªØ li·ªáu</strong>
                H√£y ki·ªÉm tra l·∫°i m√£ ƒë∆°n ho·∫∑c th·ª≠ tra c·ª©u l·∫°i.
              </div>
            </td>
          </tr>
        `;
      }

      function updateStatus(message, variant = "idle") {
        if (!statusBar) return;
        statusBar.textContent = message;
        statusBar.dataset.variant = variant;
      }

      function toggleLoading(isLoading) {
        submitBtn.disabled = isLoading;
        submitBtn.innerHTML = isLoading
          ? '<span aria-hidden="true">‚è≥</span> ƒêang tra c·ª©u...'
          : submitBtnDefault;
      }

      function showResults() {
        if (tableWrapper) {
          tableWrapper.hidden = false;
        }
      }

      function renderNotes(order = {}) {
        if (!notesSection || !hasLookup) {
          hideNotes();
          return;
        }
        const description = String(order?.description ?? "").trim();
        const privateDescription = String(
          order?.privateDescription ?? ""
        ).trim();
        const hasNotes = Boolean(description.length || privateDescription.length);

        if (!hasNotes) {
          hideNotes();
          return;
        }

        notesSection.hidden = false;
        descriptionText.textContent =
          description || "Kh√¥ng c√≥ m√¥ t·∫£ c√¥ng khai.";
        privateDescriptionText.textContent =
          privateDescription || "Kh√¥ng c√≥ ghi ch√∫ n·ªôi b·ªô.";
      }

      function hideNotes() {
        if (!notesSection) return;
        notesSection.hidden = true;
        if (descriptionText) descriptionText.textContent = "";
        if (privateDescriptionText)
          privateDescriptionText.textContent = "";
      }
    </script>
  </body>
</html>
